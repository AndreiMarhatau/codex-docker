name: Update codex-docker image digest

on:
  workflow_run:
    workflows: ["Build and Publish codex-docker"]
    types: [completed]
  workflow_dispatch:

jobs:
  update-digest:
    if: ${{ github.event_name == 'workflow_dispatch' || (github.event.workflow_run.conclusion == 'success' && github.event.workflow_run.head_branch == 'main') }}
    runs-on: ubuntu-latest
    env:
      HEAD_SHA: ${{ github.event_name == 'workflow_run' && github.event.workflow_run.head_sha || github.sha }}
    permissions:
      contents: write
      pull-requests: write
      packages: read
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.PAT }}
          ref: ${{ github.event.workflow_run.head_branch }}

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Resolve image digest
        id: digest
        env:
          EVENT_NAME: ${{ github.event_name }}
        run: |
          image_repo="$(printf '%s' "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          image_repo="ghcr.io/${image_repo}"
          if [[ "${EVENT_NAME}" == "workflow_dispatch" ]]; then
            image_tag="${image_repo}:latest"
          else
            image_tag="${image_repo}:sha-${HEAD_SHA}"
          fi
          digest="$(docker buildx imagetools inspect "${image_tag}" | awk '/Digest:/ {print $2; exit}')"
          if [[ -z "${digest}" ]]; then
            echo "Digest not found for ${image_tag}" >&2
            exit 1
          fi
          echo "digest=${digest}" >> "${GITHUB_OUTPUT}"

      - name: Update codex-docker image reference
        env:
          IMAGE_REPO: ${{ github.repository }}
          DIGEST: ${{ steps.digest.outputs.digest }}
        run: |
          python - <<'PY'
          import os
          import pathlib
          import re

          image_repo = os.environ["IMAGE_REPO"].lower()
          image = f"ghcr.io/{image_repo}@{os.environ['DIGEST']}"
          path = pathlib.Path("codex-docker")
          data = path.read_text()
          pattern = r'IMAGE_NAME="\${IMAGE_NAME:-[^"]+}"'
          replacement = f'IMAGE_NAME="$' + '{IMAGE_NAME:-' + image + '}"'
          updated = re.sub(pattern, replacement, data)
          if updated != data:
              path.write_text(updated)
          else:
              print("codex-docker already up to date.")
          PY

      - name: Create pull request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.PAT }}
          branch: update-image-digest-${{ env.HEAD_SHA }}
          delete-branch: true
          commit-message: "Update codex-docker image digest"
          title: "Update codex-docker image digest"
          body: "Automated update to pin codex-docker to the latest published image digest."

      - name: Enable auto-merge
        if: ${{ steps.cpr.outputs.pull-request-number != '' }}
        uses: peter-evans/enable-pull-request-automerge@v3
        with:
          token: ${{ secrets.PAT }}
          pull-request-number: ${{ steps.cpr.outputs.pull-request-number }}
          merge-method: squash
