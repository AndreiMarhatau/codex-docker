#!/usr/bin/env bash
set -euo pipefail

IMAGE_NAME="${IMAGE_NAME:-ghcr.io/andreimarhatau/codex-docker:latest}"

# Resolve the real directory of this script (even when installed as a symlink).
script_source="${BASH_SOURCE[0]}"
while [[ -h "${script_source}" ]]; do
  base_dir="$(cd "$(dirname "${script_source}")" && pwd)"
  script_source="$(readlink "${script_source}")"
  [[ "${script_source}" != /* ]] && script_source="${base_dir}/${script_source}"
done
script_dir="$(cd "$(dirname "${script_source}")" && pwd)"

extra_mounts=()
cleanup_paths=()
cleanup() {
  for path in "${cleanup_paths[@]:-}"; do
    rm -rf "${path}"
  done
}
trap cleanup EXIT
container_home="${CODEX_CONTAINER_HOME:-/tmp/codex-home}"
container_codex_home="${container_home}/.codex"
host_uid="$(id -u)"
host_gid="$(id -g)"
host_codex_dir=""
host_container_home="$(mktemp -d)"
cleanup_paths+=( "${host_container_home}" )

if [[ -d "${HOME}/.codex" ]]; then
  host_codex_dir="${HOME}/.codex"
else
  host_codex_dir="${host_container_home}/.codex"
  mkdir -p "${host_codex_dir}"
  echo "Warning: ${HOME}/.codex not found; using temporary Codex config dir." >&2
fi

extra_mounts+=( -v "${host_container_home}:${container_home}" )
if [[ "${host_codex_dir}" != "${host_container_home}/.codex" ]]; then
  extra_mounts+=( -v "${host_codex_dir}:${container_codex_home}" )
fi

project_agents_file="${script_dir}/DOCKER_AGENTS.md"
agents_override_target="${container_codex_home}/AGENTS.override.md"
append_agents_file="${CODEX_AGENTS_APPEND_FILE:-}"
combined_agents_file=""
mount_paths_var="${CODEX_MOUNT_PATHS:-}"

if [[ -n "${append_agents_file}" ]]; then
  if [[ -f "${append_agents_file}" ]]; then
    temp_dir="$(mktemp -d)"
    cleanup_paths+=( "${temp_dir}" )
    combined_agents_file="${temp_dir}/AGENTS.override.md"
    if [[ -f "${project_agents_file}" ]]; then
      cat "${project_agents_file}" "${append_agents_file}" > "${combined_agents_file}"
    else
      cat "${append_agents_file}" > "${combined_agents_file}"
    fi
    # Mount the combined agents file into Codex's home without touching the host's ~/.codex.
    extra_mounts+=( -v "${combined_agents_file}:${agents_override_target}:ro" )
  else
    echo "Warning: CODEX_AGENTS_APPEND_FILE '${append_agents_file}' not found; skipping append." >&2
  fi
else
  if [[ -f "${project_agents_file}" ]]; then
    # Mount the container-specific agents file into Codex's home without touching the host's ~/.codex.
    extra_mounts+=( -v "${project_agents_file}:${agents_override_target}:ro" )
  else
    echo "Warning: ${project_agents_file} not found; running without container AGENTS.override.md." >&2
  fi
fi

if [[ -n "${mount_paths_var}" ]]; then
  IFS=':' read -r -a mount_paths <<< "${mount_paths_var}"
  for mount_path in "${mount_paths[@]}"; do
    if [[ -z "${mount_path}" ]]; then
      continue
    fi
    if [[ -e "${mount_path}" ]]; then
      extra_mounts+=( -v "${mount_path}:${mount_path}" )
    else
      echo "Warning: CODEX_MOUNT_PATHS entry '${mount_path}' not found; skipping mount." >&2
    fi
  done
fi

# Run Codex interactively from the current directory, mounting it at /workspace/<folder-name>.
folder_name="$(basename "$PWD")"
container_workspace="/workspace/${folder_name}"

# Generate a unique container name (override with CONTAINER_NAME if desired).
CONTAINER_NAME="${CONTAINER_NAME:-codex-$(date +%s)-$RANDOM}"

# Highlight the exec helper command for easy copy/paste.
if [[ -t 1 ]]; then
  color="\033[1;36m"   # bright cyan
  reset="\033[0m"
else
  color=""
  reset=""
fi

echo "To open another terminal inside this container along with codex, run:"
printf "  ${color}docker exec -it %s /bin/bash${reset}\n" "${CONTAINER_NAME}"

tty_flag=""
if [[ -t 0 && -t 1 ]]; then
  tty_flag="-t"
fi

docker run --rm -i \
  ${tty_flag} \
  --name "${CONTAINER_NAME}" \
  --user "${host_uid}:${host_gid}" \
  -e HOME="${container_home}" \
  -v "${PWD}:${container_workspace}" \
  -w "${container_workspace}" \
  "${extra_mounts[@]}" \
  "${IMAGE_NAME}" "$@"
