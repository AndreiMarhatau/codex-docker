#!/usr/bin/env bash
set -euo pipefail

IMAGE_NAME="${IMAGE_NAME:-ghcr.io/andreimarhatau/codex-docker@sha256:9bfaa9f7246f6127df2dafe3e31fcabe62f59004c792ffb65696096576c89839}"

extra_mounts=()
cleanup_paths=()
cleanup() {
  for path in "${cleanup_paths[@]:-}"; do
    rm -rf "${path}"
  done
}
trap cleanup EXIT
if [[ -d "${HOME}/.codex" ]]; then
  extra_mounts+=( -v "${HOME}/.codex:/root/.codex" )
  extra_mounts+=( -v "${HOME}/.codex:/root/.codex-host:ro" )
else
  echo "Warning: ${HOME}/.codex not found; running without host Codex config." >&2
fi

mount_paths_var="${CODEX_MOUNT_PATHS:-}"
mount_paths_ro_var="${CODEX_MOUNT_PATHS_RO:-}"
mount_maps_var="${CODEX_MOUNT_MAPS:-}"
mount_maps_ro_var="${CODEX_MOUNT_MAPS_RO:-}"
artifacts_host_dir="${CODEX_ARTIFACTS_DIR:-}"
artifacts_target="/root/.artifacts"

passthrough_envs_var="${CODEX_PASSTHROUGH_ENV:-}"
extra_envs=()
should_passthrough_env() {
  local env_name="$1"
  case "${env_name}" in
    ""|_|HOME|PATH|PWD|OLDPWD|SHELL|SHLVL|TERM|TMP|TEMP|TMPDIR|USER|LOGNAME|MAIL)
      return 1
      ;;
    LANG|LC_*|COLORTERM|LS_COLORS|HOSTNAME|HOST|DISPLAY|SESSION_MANAGER|WAYLAND_DISPLAY)
      return 1
      ;;
    XDG_*|SSH_*|GPG_*|DBUS_*|BASH*|ZSH*|PROMPT*|PS1|PS2|PS4)
      return 1
      ;;
    CODEX_*|IMAGE_NAME|CONTAINER_NAME|DOCKER_*|EDITOR|VISUAL|PAGER|MANPAGER|LESS*)
      return 1
      ;;
  esac
  return 0
}

if [[ -n "${passthrough_envs_var}" ]]; then
  IFS=',' read -r -a passthrough_envs <<< "${passthrough_envs_var}"
  for env_name in "${passthrough_envs[@]}"; do
    if [[ -n "${env_name}" ]]; then
      extra_envs+=( -e "${env_name}" )
    fi
  done
else
  while IFS= read -r -d '' env_entry; do
    env_name="${env_entry%%=*}"
    if should_passthrough_env "${env_name}"; then
      extra_envs+=( -e "${env_name}" )
    fi
  done < <(env -0)
fi

temp_dir="$(mktemp -d)"
cleanup_paths+=( "${temp_dir}" )

append_agents_file="${CODEX_AGENTS_APPEND_FILE:-}"
combined_agents_file="${temp_dir}/AGENTS.override.md"
touch "${combined_agents_file}"
extra_mounts+=( -v "${combined_agents_file}:/root/.codex/AGENTS.override.md" )

if [[ -n "${append_agents_file}" ]]; then
  if [[ -f "${append_agents_file}" ]]; then
    append_temp_file="${temp_dir}/AGENTS.append.md"
    cat "${append_agents_file}" > "${append_temp_file}"
    extra_mounts+=( -v "${append_temp_file}:/root/.codex-append/AGENTS.append.md:ro" )
  else
    echo "Warning: CODEX_AGENTS_APPEND_FILE '${append_agents_file}' not found; skipping append." >&2
  fi
fi

if [[ -n "${mount_paths_var}" ]]; then
  IFS=':' read -r -a mount_paths <<< "${mount_paths_var}"
  for mount_path in "${mount_paths[@]}"; do
    if [[ -z "${mount_path}" ]]; then
      continue
    fi
    if [[ -e "${mount_path}" ]]; then
      extra_mounts+=( -v "${mount_path}:${mount_path}" )
    else
      echo "Warning: CODEX_MOUNT_PATHS entry '${mount_path}' not found; skipping mount." >&2
    fi
  done
fi

if [[ -n "${mount_paths_ro_var}" ]]; then
  IFS=':' read -r -a mount_paths_ro <<< "${mount_paths_ro_var}"
  for mount_path in "${mount_paths_ro[@]}"; do
    if [[ -z "${mount_path}" ]]; then
      continue
    fi
    if [[ -e "${mount_path}" ]]; then
      extra_mounts+=( -v "${mount_path}:${mount_path}:ro" )
    else
      echo "Warning: CODEX_MOUNT_PATHS_RO entry '${mount_path}' not found; skipping mount." >&2
    fi
  done
fi

if [[ -n "${mount_maps_ro_var}" ]]; then
  IFS=':' read -r -a mount_maps_ro <<< "${mount_maps_ro_var}"
  for mount_map in "${mount_maps_ro[@]}"; do
    if [[ -z "${mount_map}" ]]; then
      continue
    fi

    if [[ "${mount_map}" != *=* ]]; then
      echo "Warning: CODEX_MOUNT_MAPS_RO entry '${mount_map}' is invalid; expected '/host/path=/container/path'." >&2
      continue
    fi

    host_path="${mount_map%%=*}"
    container_path="${mount_map#*=}"

    if [[ -z "${host_path}" || -z "${container_path}" ]]; then
      echo "Warning: CODEX_MOUNT_MAPS_RO entry '${mount_map}' is invalid; expected '/host/path=/container/path'." >&2
      continue
    fi

    if [[ "${container_path}" != /* ]]; then
      echo "Warning: CODEX_MOUNT_MAPS_RO container path '${container_path}' must be absolute; skipping mount." >&2
      continue
    fi

    if [[ -e "${host_path}" ]]; then
      extra_mounts+=( -v "${host_path}:${container_path}:ro" )
    else
      echo "Warning: CODEX_MOUNT_MAPS_RO host path '${host_path}' not found; skipping mount." >&2
    fi
  done
fi

if [[ -n "${mount_maps_var}" ]]; then
  IFS=':' read -r -a mount_maps <<< "${mount_maps_var}"
  for mount_map in "${mount_maps[@]}"; do
    if [[ -z "${mount_map}" ]]; then
      continue
    fi

    if [[ "${mount_map}" != *=* ]]; then
      echo "Warning: CODEX_MOUNT_MAPS entry '${mount_map}' is invalid; expected '/host/path=/container/path'." >&2
      continue
    fi

    host_path="${mount_map%%=*}"
    container_path="${mount_map#*=}"

    if [[ -z "${host_path}" || -z "${container_path}" ]]; then
      echo "Warning: CODEX_MOUNT_MAPS entry '${mount_map}' is invalid; expected '/host/path=/container/path'." >&2
      continue
    fi

    if [[ "${container_path}" != /* ]]; then
      echo "Warning: CODEX_MOUNT_MAPS container path '${container_path}' must be absolute; skipping mount." >&2
      continue
    fi

    if [[ -e "${host_path}" ]]; then
      extra_mounts+=( -v "${host_path}:${container_path}" )
    else
      echo "Warning: CODEX_MOUNT_MAPS host path '${host_path}' not found; skipping mount." >&2
    fi
  done
fi

if [[ -n "${artifacts_host_dir}" ]]; then
  if [[ -e "${artifacts_host_dir}" ]]; then
    extra_mounts+=( -v "${artifacts_host_dir}:${artifacts_target}" )
  else
    echo "Warning: CODEX_ARTIFACTS_DIR '${artifacts_host_dir}' not found; skipping artifacts mount." >&2
  fi
fi

# Run Codex interactively from the current directory, mounting it at /workspace/<folder-name>.
folder_name="$(basename "$PWD")"
container_workspace="/workspace/${folder_name}"

# Generate a unique container name (override with CONTAINER_NAME if desired).
CONTAINER_NAME="${CONTAINER_NAME:-codex-$(date +%s)-$RANDOM}"

# Highlight the exec helper command for easy copy/paste.
if [[ -t 1 ]]; then
  color="\033[1;36m"   # bright cyan
  reset="\033[0m"
else
  color=""
  reset=""
fi

echo "To open another terminal inside this container along with codex, run:"
printf "  ${color}docker exec -it %s /bin/bash${reset}\n" "${CONTAINER_NAME}"

tty_flag=""
if [[ -t 0 && -t 1 ]]; then
  tty_flag="-t"
fi

docker run --rm -i \
  ${tty_flag} \
  --name "${CONTAINER_NAME}" \
  -v "${PWD}:${container_workspace}" \
  -w "${container_workspace}" \
  "${extra_mounts[@]}" \
  "${extra_envs[@]}" \
  "${IMAGE_NAME}" "$@"
